CC=gcc
CFLAGS=-O2
OBJ:=obj
SRC:=src
MODULE_NAME := $(notdir $(patsubst %/,%,$(CURDIR)))

SOURCES := $(wildcard $(SRC)/*.c)
OBJECTS := $(patsubst $(SRC)/%.c,$(OBJ)/%.o, $(SOURCES))

all: $(MODULE_NAME).ko
$(MODULE_NAME).ko: $(OBJECTS) obj/lkm_info.o obj/rcore_symbols.o
	$(CC) -shared -o $@ -nostdlib $(OBJECTS) obj/lkm_info.o obj/rcore_symbols.o
$(OBJ)/%.o:$(SRC)/%.c
	$(CC) $(CFLAGS) -fpic -nostdlib -c $< -o $@
obj/lkm_info.o: lkm_info.txt
	objcopy --input binary --output elf64-x86-64 \
		--binary-architecture i386:x86-64\
		--rename-section .data=.rcore-lkm,CONTENTS,READONLY\
		lkm_info.txt obj/lkm_info.o
	strip obj/lkm_info.o
obj/rcore_symbols.o:
	nm ../../kernel/target/x86_64/release/rcore >symbols.txt
	objcopy --input binary \
        --output elf64-x86-64 \
        --binary-architecture i386:x86-64 \
        symbols.txt obj/rcore_symbols.o
clean:
	rm -fr $(OBJECTS) obj/lkm_info.o obj/rcore_symbols.o $(MODULE_NAME).ko

.PHONY: clean
